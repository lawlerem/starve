---
title: "starve-tour"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{starve-tour}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---







# Introduction


```r
set.seed(4326)
library(starve)
```

The starve package implements a spatio-temporal generalized linear mixed model for analyzing discrete-time, continuous-space data.
Throughout this vignette we will refer to the time unit as year/yearly, although any other regular unit (daily, monthly, etc.) can be used.
Functionality includes maximum likelihood inference, model-based spatial interpolation, forecasting and hindcasting, and simulations.
The sf, raster, and stars packages are tightly integrated into the starve package, allowing users to easily incorporate the starve package into their existing workflows.

The spatio-temporal GLMM is structured as a hierarchical model with 3 levels:

1. an observation equation describing the response distribution and covariate effects
2. a first level of spatio-temporal random effects describing the value of an unobserved spatio-temporal process, and
3. a second level of temporal random effects describing how the spatial surface changes as a whole from year to year.






# Data

The starve package expects data to be a sf data.frame with point geometries.
See the sf package.
The point geometries can have any valid geographic coordinate reference system, projected or unprojected, latitude/longitude or eastings/northings, or have no coordinate reference system (if appropriate).
In addition to the geometry column the sf data.frame should also include a response variable, the time index of the observation, and optionally any covariates desired.
The bird_survey dataset included in the starve package is an example of the necessary data format.


```r
data(bird_survey)
bird_survey
#> Simple feature collection with 783 features and 2 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>    cnt year                       geom
#> 1    4 1994 POINT (-89.24779 36.82526)
#> 2    2 1994 POINT (-90.74799 36.59369)
#> 3    8 1994 POINT (-91.68653 36.86373)
#> 4    6 1994  POINT (-93.9101 36.66086)
#> 5   15 1994 POINT (-94.23886 36.56423)
#> 6    2 1994 POINT (-89.52656 37.30663)
#> 7   17 1994 POINT (-90.30749 37.25986)
#> 8    7 1994 POINT (-91.55293 37.37596)
#> 9   13 1994 POINT (-91.42393 37.90398)
#> 10  10 1994   POINT (-92.0354 37.7511)
```

The 'bird_survey' data holds the results of a yearly survey of Carolina wren in the state of Missouri, USA.
The number of individual birds encountered is stored in the 'cnt' column.
The year that each observation was taken in stored in the 'year' column.
The location of each observation, taken as the centroid of transect, is given in the 'geom' column.
We'll work with a smaller subset of the data in the vignette.


```r
bird_survey<- subset(bird_survey, year >= 2005)
```

## Creating and fitting a model

The 'strv_prepare' function uses a supplied sf data.frame to create a 'starve' object.



```r
bird_model<- strv_prepare(
  cnt ~ time(year , "rw"),
  data = bird_survey,
  distribution = "poisson"
)
```


The first argument supplied to 'strv_prepare' is a formula, similar those used in calls to 'lm' or 'glm'.
Formulae used in this package can include a number of terms with a special syntax, described more thoroughly in section [Formula syntax].
The response distribution must also be specified, defaulting to a Gaussian distribution.
The available response distributions are described in section [Response distribution] and can also be viewed in your R session with the command 'get_starve_distributions("distribution")'.
Optional arguments for strv_prepare are described in the help file for the function.

The new starve object is shown below.


```r
bird_model
#> A starve model object
#> 
#> Model formula: cnt ~ time(year, "rw")
#> Response distribution: poisson
#> Link function: log
#> Optimizer message: Model not yet fitted.
#> 
#> Data is a simple feature collection with 404 features
#> CRS: WGS 84
#> Bounding times: 2005 2014
#> Bounding box:
#>      xmin      ymin      xmax      ymax 
#> -95.23445  36.11935 -89.24779  40.47128
```


```r
space_parameters(bird_model)$cnt["range", "par"]<- 80
space_parameters(bird_model)$cnt["range", "fixed"]<- TRUE
```

The individual components of a 'starve" object are explained in the following sections.
For now, note that printing the model give a summary of the model form, including the model formula, response distribution, link function, and an optimizer message that gives info on if/how the model is fit, and a summary of the data.
The 'strv_fit' function finds the maximum likelihood (ML) estimates of the model parameters.
The parameter values in the starve object will be the starting values used when finding the ML estimate, and unless you change them then default starting values will be used.
Details for changing these values is given in section [Modifying a starve model].


```r
bird_model<- strv_fit(
  bird_model,
  silent = TRUE
)
```

The output of the 'strv_fit' function is a 'starve' object with the ML parameter estimates, and you can see that the optimizer message has changed to tell you if the optimization procedure successfully converged.


```r
bird_model
#> A starve model object
#> 
#> Model formula: cnt ~ time(year, "rw")
#> Response distribution: poisson
#> Link function: log
#> Optimizer message: relative convergence (4)
#> 
#> Data is a simple feature collection with 404 features
#> CRS: WGS 84
#> Bounding times: 2005 2014
#> Bounding box:
#>      xmin      ymin      xmax      ymax 
#> -95.23445  36.11935 -89.24779  40.47128
```

We'll store this fitted model so we can restore it throughout the rest of the vignette.


```r
original_model<- bird_model
```



# The starve model object

In this section we detail the various components of the 'starve' class.
The starve package makes use of S4 classes.
Users who are unfamiliar with S4 can think of an S4 class as a list, but elements of the list are accessed or modified using functions instead of the '$' or '[[' syntax.

## Parameter estimates


```r
convergence(bird_model)
#> [1] "relative convergence (4)"
```

The convergence message is only available after fitting a model.
Some of the convergence messages that indicate successful convergence of the optimization routine are

- "X-convergence (3)"
- "Relative convergence (4)"
- "Both X- and relative convergence (5)"

Some messages that indicate the optimization routine failed to converge are

- "Singular convergence"
- "false convergence"
- "function evaluation limit reached"

See '?nlminb' and the PORT routines documentation for more details.


The parameters hold the parameter values/estimates, the standard errors of the parameter estimates (for a fitted model), and whether the parameters are held fixed in the model.
These quantities are held in the 'par', 'se', and 'fixed' columns, respectively.
The spatial covariance function, response distribution, and link function used are also part of the parameter descriptions.
The parameters are split into groups according to the different conceptual parts of the model.


```r
covariance_function(bird_model)
#> [1] "exponential"
space_parameters(bird_model)
#> $cnt
#>               par          se fixed
#> sd     0.02174469 0.002401241 FALSE
#> range 80.00000000 0.000000000  TRUE
#> nu     0.50000000 0.000000000  TRUE
```

The spatial parameters describe the spatial covariance function for each response variable.
The starve package uses a Matern covariance function with the following parameters:

- **sd**: a scale parameter. Higher values correspond to spatial surfaces with larger peaks and lower valleys. Must be greater than 0.
- **range**: a range parameter. Typically interpreted as the distance by which two locations need to be separated to be approximately uncorrelated.
- **nu**: a smoothness parameter. Higher values correspond to smoother spatial surfaces. The smoothness parameter is only estimated when the covariance function is 'matern'. Must be greater than 0.


```r
time_parameters(bird_model)
#> $cnt
#>           par         se fixed
#> mu  1.8539486 1.39041602 FALSE
#> ar1 0.9900000 0.00000000  TRUE
#> sd  0.1929791 0.05787956 FALSE
```

The time parameters describe the temporal structure of the random effects.
An autoregressive order 1 AR(1) model is used:

- **mu**: A mean parameter. The overall mean or the baseline level of the random effects.
- **ar1**: A correlation parameter. Higher values correspond to adjacent years being more highly correlated. Must be between -1 and +1.
- **sd**: A scale parameter. Higher values correspond to more year-to-year variation. Must be greater than 0.


```r
response_distribution(bird_model)
#> [1] "poisson"
response_parameters(bird_model)
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
```

The response parameters describe e.g. the observation error, overdispersion, etc.
The specific parameters depend on the response distribution used and are described in section [Response distribution].



```r
fixed_effects(bird_model)
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
```

The fixed effects describe the effects of covariates, as in a generalized linear model.
A description of how to include covariates in a starve analysis is given in section [Including covariates].



```r
parameters(bird_model)
#> An object of class "parameters"
#> Slot "covariance_function":
#> [1] "exponential"
#> 
#> Slot "space_parameters":
#> $cnt
#>               par          se fixed
#> sd     0.02174469 0.002401241 FALSE
#> range 80.00000000 0.000000000  TRUE
#> nu     0.50000000 0.000000000  TRUE
#> 
#> 
#> Slot "time_parameters":
#> $cnt
#>           par         se fixed
#> mu  1.8539486 1.39041602 FALSE
#> ar1 0.9900000 0.00000000  TRUE
#> sd  0.1929791 0.05787956 FALSE
#> 
#> 
#> Slot "response_distribution":
#> [1] "poisson"
#> 
#> Slot "response_parameters":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
#> 
#> 
#> Slot "link_function":
#> [1] "log"
#> 
#> Slot "fixed_effects":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
```

You can extract all of the parameter values using the 'parameters' function.


## Random effect predictions

The time effects are non-spatial random effects that describe the year-to-year change of the spatio-temporal random effects.
Higher predicted values of the time effects correspond to years with a higher yearly mean, but the time effects themselves are not interpretable as yearly means.
The main purpose of the time effects is to induce a correlation structure in the spatio-temporal random effects.


```r
time_effects(bird_model)
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>          Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
#> w   1.6101024 1.8382359 1.8784224 1.8766181 1.9596378 2.0395785
#> se  0.3869975 0.3873266 0.3875028 0.3877553 0.3880536 0.3893949
#> dimension(s):
#>          from to offset delta point values
#> year        1 10   2005     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE    cnt
```

The spatio-temporal random effects describe a spatial surface that varies from year to year.
The locations of the random effects act like the nodes in a mesh used in the INLA package, or basis functions used in a spline model.
The spatial surface at new locations are predicted using the values of these random effects.
The random effects are split into two groups.
The persistent graph random effects are placed at nodes that re-occur at the same location every year, and thus help
model the temporal structure of the model.
These random effects form a data cube, and we hold the random effect in a 'stars' object from the stars package.


```r
pg_re(bird_model)
#> stars object with 3 dimensions and 2 attributes
#> attribute(s):
#>            Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
#> w   -0.07318679 1.2051074 1.8464812 1.7884431 2.3749914 3.6480021
#> se   0.11182111 0.1791888 0.2521195 0.2887181 0.3810098 0.7530985
#> dimension(s):
#>          from to offset delta refsys point                                                    values
#> geom        1 63     NA    NA WGS 84  TRUE POINT (-89.24779 36.82526),...,POINT (-95.23445 40.46577)
#> year        1 10   2005     1     NA FALSE                                                      NULL
#> variable    1  1     NA    NA     NA FALSE                                                       cnt
```

The transient graph random effects are placed at nodes at the location of each data point within a year (unless that
  location is already a persistent graph node location), and only in the year that the data point is observed.
These random effects are necessary to know the value of the spatio-temporal random effect value at each location.
Since the transient graph node locations do not form a data cube, we hold them in a 'long_stars' object (from the starve package).
The default options for the 'strv_prepare' function use all of the data locations as the persistent graph locations, so in our example there are no transient graph random effects.


```r
tg_re(bird_model)
#> An object of class "long_stars"
#> Slot "values":
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>     Min. 1st Qu. Median Mean 3rd Qu. Max. NA's
#> w      0       0      0    0       0    0    0
#> se    NA      NA     NA  NaN      NA   NA    1
#> dimension(s):
#>          from to point values
#> i           1  1 FALSE [1,NA)
#> variable    1  1 FALSE    cnt
#> 
#> Slot "locations":
#> Simple feature collection with 0 features and 1 field
#> Bounding box:  xmin: NA ymin: NA xmax: NA ymax: NA
#> Geodetic CRS:  WGS 84
#> [1] year geom
#> <0 rows> (or 0-length row.names)
```

A list containing both sets of random effects can be extracted using the 'random_effects' function.


```r
random_effects(bird_model)
#> $pg_re
#> stars object with 3 dimensions and 2 attributes
#> attribute(s):
#>            Min.   1st Qu.    Median      Mean   3rd Qu.      Max.
#> w   -0.07318679 1.2051074 1.8464812 1.7884431 2.3749914 3.6480021
#> se   0.11182111 0.1791888 0.2521195 0.2887181 0.3810098 0.7530985
#> dimension(s):
#>          from to offset delta refsys point                                                    values
#> geom        1 63     NA    NA WGS 84  TRUE POINT (-89.24779 36.82526),...,POINT (-95.23445 40.46577)
#> year        1 10   2005     1     NA FALSE                                                      NULL
#> variable    1  1     NA    NA     NA FALSE                                                       cnt
#> 
#> $tg_re
#> An object of class "long_stars"
#> Slot "values":
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>     Min. 1st Qu. Median Mean 3rd Qu. Max. NA's
#> w      0       0      0    0       0    0    0
#> se    NA      NA     NA  NaN      NA   NA    1
#> dimension(s):
#>          from to point values
#> i           1  1 FALSE [1,NA)
#> variable    1  1 FALSE    cnt
#> 
#> Slot "locations":
#> Simple feature collection with 0 features and 1 field
#> Bounding box:  xmin: NA ymin: NA xmax: NA ymax: NA
#> Geodetic CRS:  WGS 84
#> [1] year geom
#> <0 rows> (or 0-length row.names)
```

## Data

The data used in the model holds the data supplied to 'strv_prepare', and is held in a 'long_stars' object.
The 'predictions' slot contains a stars object for the random effect predictions (w), the response mean before applying the link function (linear), and the response mean after applying the link function (response).
Standard errors are also given for these predictions.
The 'locations' slot contains an sf object with columns for the response variable, any covariates, and the year column.
Note that the 'strv_prepare' function may sort the rows of the supplied data.


```r
data_predictions(bird_model)
#> An object of class "long_stars"
#> Slot "values":
#> stars object with 2 dimensions and 6 attributes
#> attribute(s):
#>                     Min.   1st Qu.    Median      Mean    3rd Qu.       Max.
#> w            -0.05159183 1.4006207 2.0031676 1.9485048  2.4918000  3.6480021
#> w_se          0.11182111 0.1621917 0.1938174 0.2182845  0.2558407  0.6029834
#> linear       -0.05159183 1.4006207 2.0031676 1.9485048  2.4918000  3.6480021
#> linear_se     0.11182111 0.1621917 0.1938174 0.2182845  0.2558407  0.6029834
#> response      0.94971643 4.0577197 7.4125242 9.4207425 12.0830099 38.3978753
#> response_se   0.40504429 1.0383513 1.4998530 1.6651991  2.0711062  4.8718577
#> dimension(s):
#>          from  to offset delta point values
#> i           1 404      1     1 FALSE   NULL
#> variable    1   1     NA    NA FALSE    cnt
#> 
#> Slot "locations":
#> Simple feature collection with 404 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>     cnt year graph_idx                       geom
#> 422   1 2005        63 POINT (-95.23445 40.46577)
#> 417   7 2005        62 POINT (-95.03312 40.02546)
#> 402   5 2005        59 POINT (-94.66548 39.65398)
#> 415   7 2005        58 POINT (-94.50103 39.39702)
#> 416   3 2005        57 POINT (-94.14222 40.10026)
#> 392   3 2005        29   POINT (-94.1192 37.1404)
#> 420   4 2005        43 POINT (-94.10504 38.66985)
#> 384  11 2005        37  POINT (-93.9101 36.66086)
#> 391   7 2005        26 POINT (-93.85185 37.77059)
#> 397   2 2005        24 POINT (-93.84015 38.19498)
```

The data held in the model can be easily accessed through the 'dat' function.


```r
dat(bird_model)
#> Simple feature collection with 404 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>     cnt year graph_idx                       geom
#> 422   1 2005        63 POINT (-95.23445 40.46577)
#> 417   7 2005        62 POINT (-95.03312 40.02546)
#> 402   5 2005        59 POINT (-94.66548 39.65398)
#> 415   7 2005        58 POINT (-94.50103 39.39702)
#> 416   3 2005        57 POINT (-94.14222 40.10026)
#> 392   3 2005        29   POINT (-94.1192 37.1404)
#> 420   4 2005        43 POINT (-94.10504 38.66985)
#> 384  11 2005        37  POINT (-93.9101 36.66086)
#> 391   7 2005        26 POINT (-93.85185 37.77059)
#> 397   2 2005        24 POINT (-93.84015 38.19498)
```

The rows of 'predictions' are in the same order as the rows of 'locations'.
We can add the random effect and response mean predictions to the data for plotting purposes.


```r
tmp<- cbind(
  do.call(
    cbind,
    values(data_predictions(bird_model))[, , 1]
  ),
  dat(bird_model)
)
#> Error in (function (classes, fdef, mtable) : unable to find an inherited method for function 'values' for signature '"long_stars"'
colnames(tmp)[1:6]<- c("w", "w_se", "linear", "linear_se", "response", "response_se")
tmp
#> Simple feature collection with 25 features and 7 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.1653 ymin: 36.1487 xmax: -89.41267 ymax: 40.43233
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>            w      w_se    linear linear_se  response response_se year                       geom
#> 1  2.0779800 0.1716468 2.0779800 0.1716468  7.988316   1.3812318 2012 POINT (-93.44969 37.48708)
#> 2  2.1742585 0.1696455 2.1742585 0.1696455  8.795661   1.5028421 2012  POINT (-92.76769 36.7374)
#> 3  2.2738594 0.2732058 2.2738594 0.2732058  9.716829   2.7037776 2012 POINT (-89.66307 36.49022)
#> 4  2.7952578 0.1651262 2.7952578 0.1651262 16.366847   2.7209549 2012 POINT (-89.41267 36.74711)
#> 5  0.3158178 0.3688616 0.3158178 0.3688616  1.371380   0.5227729 2012  POINT (-95.1653 40.43233)
#> 6  1.9191796 0.2139632 1.9191796 0.2139632  6.815365   1.4748325 2013 POINT (-91.23448 36.59283)
#> 7  1.4941485 0.2571189 1.4941485 0.2571189  4.455541   1.1643838 2013  POINT (-94.56619 36.1487)
#> 8  1.4722731 0.1986460 1.4722731 0.1986460  4.359133   0.8744248 2013 POINT (-92.09355 38.93433)
#> 9  2.8309055 0.1574095 2.8309055 0.1574095 16.960812   2.6862804 2013 POINT (-89.75907 36.99413)
#> 10 3.2670159 0.1243152 3.2670159 0.1243152 26.232939   3.2737289 2013 POINT (-89.79193 37.16898)
```



## Settings

The call to 'strv_prepare' can include various options that tweak the behaviour of the data pre-processing step.
Some of these options are stored as slots in model settings:

- **formula**: this is the formula supplied to 'strv_prepare'
- **n_neighbours**: the maximum number of parents that each node in the directed acyclic graph
- **distance_units**: units used for distance calculations. All distances in the model (for example max_distance, init_range, and graph distances) have these units.
- **max_distance**: the maximum distance that a location is allowed to be from nearest-neighbour parents


```r
settings(bird_model)
#> An object of class "settings"
#> Slot "formula":
#> cnt ~ time(year, "rw")
#> 
#> Slot "n_neighbours":
#> [1] 10
#> 
#> Slot "distance_units":
#> [1] "km"
#> 
#> Slot "max_distance":
#> [1] Inf
```






# Modifying a starve model


Changing the covariance function also resets the spatial parameters, and updates the value of nu to reflect the specific covariance function as a special case of the Matern covariance.


```r
space_parameters(bird_model)
#> $cnt
#>               par          se fixed
#> sd     0.02174469 0.002401241 FALSE
#> range 80.00000000 0.000000000  TRUE
#> nu     0.50000000 0.000000000  TRUE

covariance_function(bird_model)<- "matern32"

space_parameters(bird_model)
#> $cnt
#>       par se fixed
#> sd    0.0  0 FALSE
#> range 0.0  0 FALSE
#> nu    1.5  0  TRUE
```

You can change the parameter values by accessing the relevant set of parameters, and changing the 'par' column of that data.frame.
Parameter values can be set to any numeric value, but values outside the valid range will be replaced with a default value when fitting, simulating from, or predicting using the model.
For example a 'sd' (standard deviation) parameter must be positive; if it is set to a negative value then a default of +1 will be used instead.
You can also change the 'se' and 'fixed' columns in the same way.


```r
space_parameters(bird_model)
#> $cnt
#>       par se fixed
#> sd    0.0  0 FALSE
#> range 0.0  0 FALSE
#> nu    1.5  0  TRUE
time_parameters(bird_model)
#> $cnt
#>           par         se fixed
#> mu  1.8539486 1.39041602 FALSE
#> ar1 0.9900000 0.00000000  TRUE
#> sd  0.1929791 0.05787956 FALSE

time_parameters(bird_model)$cnt[c("mu", "ar1"), "par"]<- c(10, 0.75)
space_parameters(bird_model)$cnt["range", "par"]<- 80
space_parameters(bird_model)$cnt["range", "fixed"]<- TRUE

space_parameters(bird_model)
#> $cnt
#>        par se fixed
#> sd     0.0  0 FALSE
#> range 80.0  0  TRUE
#> nu     1.5  0  TRUE
time_parameters(bird_model)
#> $cnt
#>            par         se fixed
#> mu  10.0000000 1.39041602 FALSE
#> ar1  0.7500000 0.00000000  TRUE
#> sd   0.1929791 0.05787956 FALSE
```

Changing the response distribution will automatically update the response parameters, and will change the link function based on the valid range of the response mean for that distribution.
In the example above, the response distribution was changed from a Poisson distribution with no parameters and log link to a Gaussian distribution with a standard deviation parameter and identity link.


```r
response_distribution(bird_model)
#> [1] "poisson"
response_parameters(bird_model)
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
link_function(bird_model)
#> [1] "log"

response_distribution(bird_model)<- "gaussian"

response_distribution(bird_model)
#> [1] "gaussian"
response_parameters(bird_model)
#> $cnt
#>    par se fixed
#> sd   0  0 FALSE
link_function(bird_model)
#> [1] "identity"
```

The link function can be changed to any implemented link function, even if it may give out of range predictions for the response distribution used in the model.
For example an identity link is allowed to be used with a Poisson response distribution even though an identity link may result in predictions with a negative mean.
Non-standard link functions should be used with caution, but are sometimes more desirable depending on the specific situation.


```r
link_function(bird_model)
#> [1] "identity"

link_function(bird_model)<- "logit"

link_function(bird_model)
#> [1] "logit"
```

You can modify the data in a 'starve' object by adding columns for new variables or amending data.
However because the data are pre-processed changing the number of rows will require the creation of a new model object using the 'strv_prepare' function.


```r
dat(bird_model)
#> Simple feature collection with 404 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>     cnt year graph_idx                       geom
#> 422   1 2005        63 POINT (-95.23445 40.46577)
#> 417   7 2005        62 POINT (-95.03312 40.02546)
#> 402   5 2005        59 POINT (-94.66548 39.65398)
#> 415   7 2005        58 POINT (-94.50103 39.39702)
#> 416   3 2005        57 POINT (-94.14222 40.10026)
#> 392   3 2005        29   POINT (-94.1192 37.1404)
#> 420   4 2005        43 POINT (-94.10504 38.66985)
#> 384  11 2005        37  POINT (-93.9101 36.66086)
#> 391   7 2005        26 POINT (-93.85185 37.77059)
#> 397   2 2005        24 POINT (-93.84015 38.19498)

dat(bird_model)$elev<- rnorm(nrow(dat(bird_model)))

dat(bird_model)
#> Simple feature collection with 404 features and 4 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>     cnt year graph_idx                       geom       elev
#> 422   1 2005        63 POINT (-95.23445 40.46577) -1.3221890
#> 417   7 2005        62 POINT (-95.03312 40.02546)  0.9720445
#> 402   5 2005        59 POINT (-94.66548 39.65398)  0.7193741
#> 415   7 2005        58 POINT (-94.50103 39.39702)  0.8373455
#> 416   3 2005        57 POINT (-94.14222 40.10026)  0.6659404
#> 392   3 2005        29   POINT (-94.1192 37.1404) -0.6571608
#> 420   4 2005        43 POINT (-94.10504 38.66985) -0.9045444
#> 384  11 2005        37  POINT (-93.9101 36.66086) -0.5842451
#> 391   7 2005        26 POINT (-93.85185 37.77059)  1.3389180
#> 397   2 2005        24 POINT (-93.84015 38.19498)  1.1219474
```

The model formula for including covariates such as the newly created 'elev' variable will be explained later.
Any variables used in the new formula must be present in the data held in the starve object, so add them before changing the formula.
The fixed effects parameters will be automatically updated to reflect the new formula.


```r
formula(bird_model)
#> cnt ~ time(year, "rw")
fixed_effects(bird_model)
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)

formula(bird_model)<- cnt ~ elev + time(year)

formula(bird_model)
#> cnt ~ elev + time(year)
fixed_effects(bird_model)
#> $cnt
#>      par se fixed
#> elev   0 NA FALSE
```

The distance units used in calculations can be changed to any valid distance unit provided by the 'units' package.
Distances are standardized within the model so changing the distance units should not affect inference or predictions.


```r
space_parameters(bird_model)
#> $cnt
#>        par se fixed
#> sd     0.0  0 FALSE
#> range 80.0  0  TRUE
#> nu     1.5  0  TRUE
graph(bird_model)
#> $persistent_graph
#> 
#> [1] "A directed acyclic graph with 54 nodes, with an median in-degree of 10."
#> [1] "The average edge distance is 90.66km."
#> 
#> $transient_graph
#> 
#> [1] "An empty directed acyclic graph."
distance_units(bird_model)<- "ft"
space_parameters(bird_model)
#> $cnt
#>            par se fixed
#> sd         0.0  0 FALSE
#> range 262467.2  0  TRUE
#> nu         1.5  0  TRUE
graph(bird_model)
#> $persistent_graph
#> 
#> [1] "A directed acyclic graph with 54 nodes, with an median in-degree of 10."
#> [1] "The average edge distance is 297430.69ft."
#> 
#> $transient_graph
#> 
#> [1] "An empty directed acyclic graph."
```



```r
bird_model<- original_model
```





# Predictions

Once a starve model has been fit, you can then use the 'strv_predict' function to predict the mean value of the response variable at unobserved locations and years.
This allows us to fill in the gaps and produce smooth maps of the response variable and forecast those maps into the future (or the past).
Predictions can be made as individual locations or as a raster.

## Point predictions

We first randomly sample a small number of points for predictions each year, and store those points as an sf data.frame.
The prediction locations can be the same every year or they can be different, and the years of the predictions can be different from those in the original data.


```r
pred_points<- st_sample(
  st_as_sfc(st_bbox(bird_survey)),
  size = 25
)
pred_points<- st_sf(
  geom = pred_points,
  year = rep(2012:2016, each = 5)
)
pred_points
#> Simple feature collection with 25 features and 1 field
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.1653 ymin: 36.1487 xmax: -89.41267 ymax: 40.43233
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>    year                       geom
#> 1  2012 POINT (-93.44969 37.48708)
#> 2  2012  POINT (-92.76769 36.7374)
#> 3  2012 POINT (-89.66307 36.49022)
#> 4  2012 POINT (-89.41267 36.74711)
#> 5  2012  POINT (-95.1653 40.43233)
#> 6  2013 POINT (-91.23448 36.59283)
#> 7  2013  POINT (-94.56619 36.1487)
#> 8  2013 POINT (-92.09355 38.93433)
#> 9  2013 POINT (-89.75907 36.99413)
#> 10 2013 POINT (-89.79193 37.16898)
```

The output is a strv_predictions object with two slots, a 'locations' slot containing an sf data.frame with any covariates used, the year, and the geometry, and a 'predictions' slot containing a stars object with attributes for:

- The spatio-temporal random effects **w**, and their standard errors **w_se**
- The response mean before applying the link function **linear**, and their standard errors **linear_se**
- the response mean after applying the link function **response**, and their standard errors **response_se**


```r
sf_pred<- strv_predict(
  bird_model,
  pred_points
)
sf_pred
#> An object of class "long_stars"
#> Slot "values":
#> stars object with 2 dimensions and 6 attributes
#> attribute(s):
#>                   Min.  1st Qu.    Median      Mean   3rd Qu.       Max.
#> w            0.3158178 1.431385 1.8055180 1.7859670 2.1742585  3.2670159
#> w_se         0.1243152 0.198646 0.2902965 0.2982862 0.4077858  0.4884019
#> linear       0.3158178 1.431385 1.8055180 1.7859670 2.1742585  3.2670159
#> linear_se    0.1243152 0.198646 0.2902965 0.2982862 0.4077858  0.4884019
#> response     1.3713804 4.184490 6.0831216 7.5430879 8.7956606 26.2329395
#> response_se  0.5227729 1.235515 1.7758977 1.8919510 2.3384548  3.8776635
#> dimension(s):
#>          from to offset delta point values
#> i           1 25      1     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE    cnt
#> 
#> Slot "locations":
#> Simple feature collection with 25 features and 1 field
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.1653 ymin: 36.1487 xmax: -89.41267 ymax: 40.43233
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>    year                       geom
#> 1  2012 POINT (-93.44969 37.48708)
#> 2  2012  POINT (-92.76769 36.7374)
#> 3  2012 POINT (-89.66307 36.49022)
#> 4  2012 POINT (-89.41267 36.74711)
#> 5  2012  POINT (-95.1653 40.43233)
#> 6  2013 POINT (-91.23448 36.59283)
#> 7  2013  POINT (-94.56619 36.1487)
#> 8  2013 POINT (-92.09355 38.93433)
#> 9  2013 POINT (-89.75907 36.99413)
#> 10 2013 POINT (-89.79193 37.16898)
```

These predictions can be converted to a single sf data.frame fairly easily.


```r
tmp<- cbind(
  do.call(cbind,values(sf_pred)[, , 1]),
  locations(sf_pred)
)
#> Error in (function (classes, fdef, mtable) : unable to find an inherited method for function 'values' for signature '"long_stars"'
colnames(tmp)[1:6]<- c("w", "w_se", "linear", "linear_se", "response", "response_se")
tmp
#> Simple feature collection with 25 features and 7 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.1653 ymin: 36.1487 xmax: -89.41267 ymax: 40.43233
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>            w      w_se    linear linear_se  response response_se year                       geom
#> 1  2.0779800 0.1716468 2.0779800 0.1716468  7.988316   1.3812318 2012 POINT (-93.44969 37.48708)
#> 2  2.1742585 0.1696455 2.1742585 0.1696455  8.795661   1.5028421 2012  POINT (-92.76769 36.7374)
#> 3  2.2738594 0.2732058 2.2738594 0.2732058  9.716829   2.7037776 2012 POINT (-89.66307 36.49022)
#> 4  2.7952578 0.1651262 2.7952578 0.1651262 16.366847   2.7209549 2012 POINT (-89.41267 36.74711)
#> 5  0.3158178 0.3688616 0.3158178 0.3688616  1.371380   0.5227729 2012  POINT (-95.1653 40.43233)
#> 6  1.9191796 0.2139632 1.9191796 0.2139632  6.815365   1.4748325 2013 POINT (-91.23448 36.59283)
#> 7  1.4941485 0.2571189 1.4941485 0.2571189  4.455541   1.1643838 2013  POINT (-94.56619 36.1487)
#> 8  1.4722731 0.1986460 1.4722731 0.1986460  4.359133   0.8744248 2013 POINT (-92.09355 38.93433)
#> 9  2.8309055 0.1574095 2.8309055 0.1574095 16.960812   2.6862804 2013 POINT (-89.75907 36.99413)
#> 10 3.2670159 0.1243152 3.2670159 0.1243152 26.232939   3.2737289 2013 POINT (-89.79193 37.16898)
```


## Raster predictions

To predict a raster for a smooth prediction surface you can supply a raster object from the 'raster' package.


```r
library(raster)
pred_raster<- raster(
  bird_survey,
  nrow = 5,
  ncol = 5
)
pred_raster
#> class      : RasterLayer 
#> dimensions : 5, 5, 25  (nrow, ncol, ncell)
#> resolution : 1.197331, 0.8703872  (x, y)
#> extent     : -95.23445, -89.24779, 36.11935, 40.47128  (xmin, xmax, ymin, ymax)
#> crs        : +proj=longlat +datum=WGS84 +no_defs
```

The 'strv_predict' function handles rasters by extracting the centroid of each raster cell and giving point predictions at those centroids.
The output is a stars object with predictions at each raster location and every year.


```r
strv_predict(
  bird_model,
  pred_raster
)
#> stars object with 4 dimensions and 6 attributes
#> attribute(s):
#>                   Min.   1st Qu.    Median      Mean   3rd Qu.       Max.
#> w            0.1165632 1.2628546 1.7334660 1.6883315 2.2486596  3.2799449
#> w_se         0.1372714 0.2256669 0.2622122 0.2709636 0.3093273  0.5823274
#> linear       0.1165632 1.2628546 1.7334660 1.6883315 2.2486596  3.2799449
#> linear_se    0.1372714 0.2256669 0.2622122 0.2709636 0.3093273  0.5823274
#> response     1.1236285 3.5355039 5.6603932 6.8032827 9.4750295 26.5743065
#> response_se  0.3615738 0.9251825 1.5386318 1.7025632 2.3132560  5.1013575
#> dimension(s):
#>          from to   offset     delta refsys point        values x/y
#> x           1  5 -95.2344   1.19733 WGS 84 FALSE          NULL [x]
#> y           1  5  40.4713 -0.870387 WGS 84 FALSE          NULL [y]
#> year        1 10     2005         1     NA    NA 2005,...,2014    
#> variable    1  1       NA        NA     NA    NA           cnt
```

If the supplied raster has values, then predictions will only be made at cells that are not NA.
See '?raster::mask' for details on creating raster with NAs.


```r
pred_raster[]<- 0
pred_raster[3, 3]<- NA
pred_raster
#> class      : RasterLayer 
#> dimensions : 5, 5, 25  (nrow, ncol, ncell)
#> resolution : 1.197331, 0.8703872  (x, y)
#> extent     : -95.23445, -89.24779, 36.11935, 40.47128  (xmin, xmax, ymin, ymax)
#> crs        : +proj=longlat +datum=WGS84 +no_defs 
#> source     : memory
#> names      : layer 
#> values     : 0, 0  (min, max)
as.matrix(pred_raster)
#>      [,1] [,2] [,3] [,4] [,5]
#> [1,]    0    0    0    0    0
#> [2,]    0    0    0    0    0
#> [3,]    0    0   NA    0    0
#> [4,]    0    0    0    0    0
#> [5,]    0    0    0    0    0
pred_out<- strv_predict(
  bird_model,
  pred_raster
)
pred_out$response[, , 1, 1]
#>          [,1]      [,2]      [,3]      [,4]      [,5]
#> [1,] 3.124363 10.152333  6.902124  5.445239  6.012205
#> [2,] 2.009250  4.441012  6.370019 15.038199 10.136670
#> [3,] 1.809554  4.563280        NA  7.978634  4.119225
#> [4,] 2.990109  3.720877 13.750836 10.016885  8.915992
#> [5,] 5.047905  6.170601  9.779581 15.841118  7.366520
```

For raster predictions an additional 'time' option is available to specify which years to make predictions for, with the default behaviour being to predict every year between the earliest and latest year in the original dataset.


```r
strv_predict(
  bird_model,
  pred_raster,
  time = 2015:2019
)
#> stars object with 4 dimensions and 6 attributes
#> attribute(s):
#>                   Min.   1st Qu.    Median      Mean   3rd Qu.       Max. NA's
#> w            0.4572746 1.1746197 1.6690188 1.6685508 2.2332788  3.2661335    5
#> w_se         0.2656764 0.4168886 0.4939964 0.4910184 0.5684977  0.6784582    5
#> linear       0.4572746 1.1746197 1.6690188 1.6685508 2.2332788  3.2661335    5
#> linear_se    0.2656764 0.4168886 0.4939964 0.4910184 0.5684977  0.6784582    5
#> response     1.5797626 3.3370960 5.3127520 6.9591768 9.3586326 26.2098026    5
#> response_se  0.7276818 1.5184555 2.7996764 3.4121351 4.5588331 13.6393414    5
#> dimension(s):
#>          from to   offset     delta refsys point        values x/y
#> x           1  5 -95.2344   1.19733 WGS 84 FALSE          NULL [x]
#> y           1  5  40.4713 -0.870387 WGS 84 FALSE          NULL [y]
#> year        1  5     2015         1     NA    NA 2015,...,2019    
#> variable    1  1       NA        NA     NA    NA           cnt
```





# Simulation

Any 'starve' object can simulate new realizations of both the random effects and observations.
You can simulated from an already fitted model, or by first defining a new model from scratch.

Passing a fitted starve model to 'strv_simulate' simulates new time effects, new random effects, and new observations, using the parameter estimates (or whichever parameter values are current).
The output of 'strv_simulate' is itself a 'starve' object.
The parameter values are the same as those of the supplied model, however all standard errors have been replace with NA.
The time effects, random effects, and observations in the output are the simulated values.
No record of the previous values are stored.


```r
sim_model<- strv_simulate(original_model)
sim_model
#> A starve model object
#> 
#> Model formula: cnt ~ time(year, "rw")
#> Response distribution: poisson
#> Link function: log
#> Optimizer message: Simulated realization from model
#> 
#> Data is a simple feature collection with 404 features
#> CRS: WGS 84
#> Bounding times: 2005 2014
#> Bounding box:
#>      xmin      ymin      xmax      ymax 
#> -95.23445  36.11935 -89.24779  40.47128
parameters(sim_model)
#> An object of class "parameters"
#> Slot "covariance_function":
#> [1] "exponential"
#> 
#> Slot "space_parameters":
#> $cnt
#>               par se fixed
#> sd     0.02174469 NA FALSE
#> range 80.00000000 NA  TRUE
#> nu     0.50000000 NA  TRUE
#> 
#> 
#> Slot "time_parameters":
#> $cnt
#>           par se fixed
#> mu  1.8539486 NA FALSE
#> ar1 0.9900000 NA  TRUE
#> sd  0.1929791 NA FALSE
#> 
#> 
#> Slot "response_distribution":
#> [1] "poisson"
#> 
#> Slot "response_parameters":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
#> 
#> 
#> Slot "link_function":
#> [1] "log"
#> 
#> Slot "fixed_effects":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
```

To simulate from a completely new model you first have to create a template sf data.frame.
The template data.frame needs to contain a column for the response variable, a column for any covariates desired, a column for the time variable, and a geometry column.
The values in the response variable column are irrelevant however the covariate values will be the ones used in the model, the time and geometry columns are also used to set up the spatio-temporal layout of the simulations.
We will use a sf data.frame with a 4x4 grid of points replicated over 5 years.


```r
sim_df<- st_as_sf(
  data.frame(
    y = 0,
    t = rep(1:5, each = 16),
    ycoord = rep(1:4, 4),
    xcoord = rep(1:4, each = 4)
  ),
  coords = c("ycoord", "xcoord")
)
sim_df
#> Simple feature collection with 80 features and 2 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: 1 ymin: 1 xmax: 4 ymax: 4
#> CRS:           NA
#> First 10 features:
#>    y t    geometry
#> 1  0 1 POINT (1 1)
#> 2  0 1 POINT (2 1)
#> 3  0 1 POINT (3 1)
#> 4  0 1 POINT (4 1)
#> 5  0 1 POINT (1 2)
#> 6  0 1 POINT (2 2)
#> 7  0 1 POINT (3 2)
#> 8  0 1 POINT (4 2)
#> 9  0 1 POINT (1 3)
#> 10 0 1 POINT (2 3)

sim_model<- strv_prepare(
  y ~ time(t),
  sim_df,
  distribution = "gaussian",
  fit = FALSE
)
```

Once a starve model is created from the template data, the parameter values and other model options (such as the covariance function, link function, response distribution, etc.) need to be set to their desired value.
After doing so you can simulate new random effects and data from the model.


```r
time_parameters(sim_model)$y[c("mu", "ar1", "sd"), "par"]<- c(10, 0.7, 1)
space_parameters(sim_model)$y[c("sd", "range"), "par"]<- c(2, 0.5)
response_parameters(sim_model)$y["sd", "par"]<- 0.5
sim_model<- strv_simulate(sim_model)
dat(sim_model)
#> Simple feature collection with 80 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: 1 ymin: 1 xmax: 4 ymax: 4
#> CRS:           NA
#> First 10 features:
#>            y t graph_idx    geometry
#> 1   9.585017 1         1 POINT (1 1)
#> 5  11.578617 1         5 POINT (1 2)
#> 9  10.764014 1         9 POINT (1 3)
#> 13  7.733157 1        13 POINT (1 4)
#> 2   8.625525 1         2 POINT (2 1)
#> 6  10.699165 1         6 POINT (2 2)
#> 10  9.580421 1        10 POINT (2 3)
#> 14  8.216801 1        14 POINT (2 4)
#> 3   7.296037 1         3 POINT (3 1)
#> 7   9.612785 1         7 POINT (3 2)
parameters(sim_model)
#> An object of class "parameters"
#> Slot "covariance_function":
#> [1] "exponential"
#> 
#> Slot "space_parameters":
#> $y
#>       par se fixed
#> sd    2.0 NA FALSE
#> range 0.5 NA FALSE
#> nu    0.5 NA  TRUE
#> 
#> 
#> Slot "time_parameters":
#> $y
#>      par se fixed
#> mu  10.0 NA FALSE
#> ar1  0.7 NA FALSE
#> sd   1.0 NA FALSE
#> 
#> 
#> Slot "response_distribution":
#> [1] "gaussian"
#> 
#> Slot "response_parameters":
#> $y
#>    par se fixed
#> sd 0.5 NA FALSE
#> 
#> 
#> Slot "link_function":
#> [1] "identity"
#> 
#> Slot "fixed_effects":
#> $y
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
```



## Simulating random effects and observations

The default behaviour for simulations is to simulate new time effects, new random effects, and new data.
We show only the first few of each to show their difference before and after simulations.


```r
time_effects(sim_model)
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 8.436   Mode:logical  
#>  1st Qu.: 9.698   NA's:5        
#>  Median :10.544                 
#>  Mean   :10.749                 
#>  3rd Qu.:12.323                 
#>  Max.   :12.743                 
#> dimension(s):
#>          from to offset delta point values
#> t           1  5      1     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE      y
pg_re(sim_model)
#> stars object with 3 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 2.316   Mode:logical  
#>  1st Qu.: 7.087   NA's:80       
#>  Median : 8.397                 
#>  Mean   : 8.795                 
#>  3rd Qu.:10.562                 
#>  Max.   :15.387                 
#> dimension(s):
#>          from to offset delta point                      values
#> geom        1 16     NA    NA  TRUE POINT (1 1),...,POINT (4 4)
#> t           1  5      1     1 FALSE                        NULL
#> variable    1  1     NA    NA FALSE                           y
head(dat(sim_model)$y)
#> [1]  9.585017 11.578617 10.764014  7.733157  8.625525 10.699165
sim_model<- strv_simulate(
  sim_model
)
time_effects(sim_model)
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 9.811   Mode:logical  
#>  1st Qu.:11.099   NA's:5        
#>  Median :11.584                 
#>  Mean   :11.295                 
#>  3rd Qu.:11.827                 
#>  Max.   :12.153                 
#> dimension(s):
#>          from to offset delta point values
#> t           1  5      1     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE      y
pg_re(sim_model)
#> stars object with 3 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 2.929   Mode:logical  
#>  1st Qu.: 7.473   NA's:80       
#>  Median : 8.760                 
#>  Mean   : 8.912                 
#>  3rd Qu.:10.304                 
#>  Max.   :14.573                 
#> dimension(s):
#>          from to offset delta point                      values
#> geom        1 16     NA    NA  TRUE POINT (1 1),...,POINT (4 4)
#> t           1  5      1     1 FALSE                        NULL
#> variable    1  1     NA    NA FALSE                           y
head(dat(sim_model)$y)
#> [1] 5.261511 6.937191 9.471781 7.491777 6.544217 7.351490
```


## Simulating only observations

Simulations of only new data, conditional on the existing time effects and random effects, can be made by giving the 'conditional=TRUE' option.
Note that the time effects and random effects are the same before and after simulation, but that the response variable is different.


```r
time_effects(sim_model)
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 9.811   Mode:logical  
#>  1st Qu.:11.099   NA's:5        
#>  Median :11.584                 
#>  Mean   :11.295                 
#>  3rd Qu.:11.827                 
#>  Max.   :12.153                 
#> dimension(s):
#>          from to offset delta point values
#> t           1  5      1     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE      y
pg_re(sim_model)
#> stars object with 3 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 2.929   Mode:logical  
#>  1st Qu.: 7.473   NA's:80       
#>  Median : 8.760                 
#>  Mean   : 8.912                 
#>  3rd Qu.:10.304                 
#>  Max.   :14.573                 
#> dimension(s):
#>          from to offset delta point                      values
#> geom        1 16     NA    NA  TRUE POINT (1 1),...,POINT (4 4)
#> t           1  5      1     1 FALSE                        NULL
#> variable    1  1     NA    NA FALSE                           y
head(dat(sim_model)$y)
#> [1] 5.261511 6.937191 9.471781 7.491777 6.544217 7.351490
sim_model<- strv_simulate(
  sim_model,
  conditional = TRUE
)
time_effects(sim_model)
#> stars object with 2 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 9.811   Mode:logical  
#>  1st Qu.:11.099   NA's:5        
#>  Median :11.584                 
#>  Mean   :11.295                 
#>  3rd Qu.:11.827                 
#>  Max.   :12.153                 
#> dimension(s):
#>          from to offset delta point values
#> t           1  5      1     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE      y
pg_re(sim_model)
#> stars object with 3 dimensions and 2 attributes
#> attribute(s):
#>        w            se          
#>  Min.   : 2.929   Mode:logical  
#>  1st Qu.: 7.473   NA's:80       
#>  Median : 8.760                 
#>  Mean   : 8.912                 
#>  3rd Qu.:10.304                 
#>  Max.   :14.573                 
#> dimension(s):
#>          from to offset delta point                      values
#> geom        1 16     NA    NA  TRUE POINT (1 1),...,POINT (4 4)
#> t           1  5      1     1 FALSE                        NULL
#> variable    1  1     NA    NA FALSE                           y
head(dat(sim_model)$y)
#> [1] 6.088303 6.048917 9.183417 6.179714 6.589092 7.417226
```







# Including covariates

## Creating a model

First we add two dummy covariates 'elev' and 'temp' to our original data.


```r
bird_survey$elev<- rnorm(
  nrow(bird_survey)
)
bird_survey$temp<- rnorm(
  nrow(bird_survey)
)
```

Then we'll fit a model, using the formula to include the new covariates.
The estimates for the covariate effects are given in the fixed effects parameters.
Offset terms can be included by setting 'fixed=TRUE' for that covariate in the fixed effects parameters.
All covariates that are named in the model formula are also present in the data stored in the starve object.


```r
bird_model<- strv_prepare(
  cnt ~ elev + temp + time(year, "rw"),
  bird_survey,
  distribution = "poisson",
  fit = TRUE
)
fixed_effects(bird_model)
#> $cnt
#>               par         se fixed
#> elev -0.008839651 0.01965174 FALSE
#> temp -0.021042830 0.02131524 FALSE
dat(bird_model)
#> Simple feature collection with 404 features and 5 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>            elev       temp cnt year graph_idx                       geom
#> 422 -0.03824043 -0.5848959   1 2005        63 POINT (-95.23445 40.46577)
#> 417 -1.37829782 -0.3255587   7 2005        62 POINT (-95.03312 40.02546)
#> 402 -0.81212892  1.3541906   5 2005        59 POINT (-94.66548 39.65398)
#> 415  1.12214376  1.0654246   7 2005        58 POINT (-94.50103 39.39702)
#> 416 -1.79021521  1.4395080   3 2005        57 POINT (-94.14222 40.10026)
#> 392  0.77144719  1.3506544   3 2005        29   POINT (-94.1192 37.1404)
#> 420 -0.62224224  0.5181382   4 2005        43 POINT (-94.10504 38.66985)
#> 384  0.12591096 -0.4473331  11 2005        37  POINT (-93.9101 36.66086)
#> 391  2.60719975 -1.7855550   7 2005        26 POINT (-93.85185 37.77059)
#> 397  0.17125484  0.2891923   2 2005        24 POINT (-93.84015 38.19498)
```

More complex covariate effects such as interaction terms, transformations, and polynomial functions can be included in the model formula.


```r
bird_model<- strv_prepare(
  cnt ~ I(abs(temp)) + poly(elev, 2) + time(year, "rw"),
  bird_survey,
  distribution = "poisson",
  fit = TRUE
)
fixed_effects(bird_model)
#> $cnt
#>                        par         se fixed
#> I(abs(temp))    0.06169483 0.03577251 FALSE
#> poly(elev, 2)1 -0.17210385 0.39295013 FALSE
#> poly(elev, 2)2  0.01056260 0.39889303 FALSE
dat(bird_model)
#> Simple feature collection with 404 features and 5 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.23445 ymin: 36.11935 xmax: -89.2478 ymax: 40.47128
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>           temp        elev cnt year graph_idx                       geom
#> 422 -0.5848959 -0.03824043   1 2005        63 POINT (-95.23445 40.46577)
#> 417 -0.3255587 -1.37829782   7 2005        62 POINT (-95.03312 40.02546)
#> 402  1.3541906 -0.81212892   5 2005        59 POINT (-94.66548 39.65398)
#> 415  1.0654246  1.12214376   7 2005        58 POINT (-94.50103 39.39702)
#> 416  1.4395080 -1.79021521   3 2005        57 POINT (-94.14222 40.10026)
#> 392  1.3506544  0.77144719   3 2005        29   POINT (-94.1192 37.1404)
#> 420  0.5181382 -0.62224224   4 2005        43 POINT (-94.10504 38.66985)
#> 384 -0.4473331  0.12591096  11 2005        37  POINT (-93.9101 36.66086)
#> 391 -1.7855550  2.60719975   7 2005        26 POINT (-93.85185 37.77059)
#> 397  0.2891923  0.17125484   2 2005        24 POINT (-93.84015 38.19498)
```


## Point predictions

We'll use the simpler covariate model for predictions.


```r
bird_model<- strv_prepare(
  cnt ~ elev + temp + time(year, "rw"),
  bird_survey,
  distribution = "poisson",
  fit = TRUE
)
```

We'll create an 'sf' object with our prediction points and years, along with the covariate values we want to use for predictions.


```r
pred_points<- st_sample(
  st_as_sfc(st_bbox(bird_survey)),
  size = 25
)
pred_points<- st_sf(
  geom = pred_points,
  year = rep(2012:2016, each = 5)
)
pred_points$elev<- rnorm(nrow(pred_points))
pred_points$temp<- rnorm(nrow(pred_points))
pred_points
#> Simple feature collection with 25 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.1871 ymin: 36.41713 xmax: -89.28986 ymax: 40.45567
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>    year                       geom       elev        temp
#> 1  2012  POINT (-94.6747 38.00656) -0.5341106  1.14034512
#> 2  2012 POINT (-94.95613 39.34523)  0.3832492  0.64683076
#> 3  2012 POINT (-91.96317 39.00377) -1.7313056 -0.35315167
#> 4  2012  POINT (-95.1871 40.20121) -0.1884050 -0.33350300
#> 5  2012 POINT (-89.28986 36.41713) -1.3101039  1.46146966
#> 6  2013 POINT (-91.43974 40.43973) -0.2127168 -0.07372531
#> 7  2013 POINT (-90.43329 39.91032) -0.4904065  1.22053703
#> 8  2013 POINT (-91.26437 37.66435)  1.1316611  0.28186046
#> 9  2013 POINT (-93.02695 38.40115)  1.2396276  0.73170276
#> 10 2013 POINT (-89.86762 39.27677)  0.5562225 -0.05959857
```

The output uses the same format as predictions without covariates, but the covariates used are also included in the resulting 'long_stars' object.


```r
strv_predict(
  bird_model,
  pred_points
)
#> An object of class "long_stars"
#> Slot "values":
#> stars object with 2 dimensions and 6 attributes
#> attribute(s):
#>                   Min.   1st Qu.    Median      Mean   3rd Qu.       Max.
#> w            0.1294090 1.3039342 1.5633743 1.5234384 1.8509455  2.5912589
#> w_se         0.1425860 0.2544787 0.3478145 0.3369996 0.4065635  0.6277657
#> linear       0.1328407 1.2775793 1.5704144 1.5199471 1.8165033  2.5781436
#> linear_se    0.1444666 0.2546541 0.3481794 0.3380897 0.4067636  0.6279888
#> response     1.1420680 3.5879438 4.8086405 5.5385904 6.1503147 13.1726623
#> response_se  0.5625102 0.9976301 1.4685277 1.8221772 2.0522474  5.3516584
#> dimension(s):
#>          from to offset delta point values
#> i           1 25      1     1 FALSE   NULL
#> variable    1  1     NA    NA FALSE    cnt
#> 
#> Slot "locations":
#> Simple feature collection with 25 features and 3 fields
#> Geometry type: POINT
#> Dimension:     XY
#> Bounding box:  xmin: -95.1871 ymin: 36.41713 xmax: -89.28986 ymax: 40.45567
#> Geodetic CRS:  WGS 84
#> First 10 features:
#>    year                       geom       elev        temp
#> 1  2012  POINT (-94.6747 38.00656) -0.5341106  1.14034512
#> 2  2012 POINT (-94.95613 39.34523)  0.3832492  0.64683076
#> 3  2012 POINT (-91.96317 39.00377) -1.7313056 -0.35315167
#> 4  2012  POINT (-95.1871 40.20121) -0.1884050 -0.33350300
#> 5  2012 POINT (-89.28986 36.41713) -1.3101039  1.46146966
#> 6  2013 POINT (-91.43974 40.43973) -0.2127168 -0.07372531
#> 7  2013 POINT (-90.43329 39.91032) -0.4904065  1.22053703
#> 8  2013 POINT (-91.26437 37.66435)  1.1316611  0.28186046
#> 9  2013 POINT (-93.02695 38.40115)  1.2396276  0.73170276
#> 10 2013 POINT (-89.86762 39.27677)  0.5562225 -0.05959857
```





## Raster predictions

Covariates for raster predictions need to be supplied in a specific format: a list with a named element for each covariate.
The elements need to have the same name as the covariate.
Each covariate element needs to be a raster with the same geometry (dimensions, resolution, extent, coordinate reference system) as the raster template for the prediction locations.
Each layer of the covariate raster must correspond to a single year and be named "T####" where #### is replaced with the year.
The leading "T" in each layer name is necessary, and needs to specifically be a capitol "T".
For example, the layer "T2005" gives the covariate values for the year 2005.
Extra years of covariate values can be supplied, the 'strv_predict' function will only use the years for which predictions are made.


```r
pred_raster<- raster(
  bird_survey,
  nrow = 5,
  ncol = 5
)
raster_elev<- stack(lapply(min(bird_survey$year):2019, function(year) {
  band<- pred_raster
  band[]<- rnorm(ncell(band))
  names(band)<- paste0("T", year)
  return(band)
}))
raster_temp<- stack(lapply(min(bird_survey$year):2019 ,function(year) {
  band<- pred_raster
  band[]<- rnorm(ncell(band))
  names(band)<- paste0("T", year)
  return(band)
}))
pred_covar<- list(
  elev = raster_elev,
  temp = raster_temp
)
pred_covar
#> $elev
#> class      : RasterStack 
#> dimensions : 5, 5, 25, 15  (nrow, ncol, ncell, nlayers)
#> resolution : 1.197331, 0.8703872  (x, y)
#> extent     : -95.23445, -89.24779, 36.11935, 40.47128  (xmin, xmax, ymin, ymax)
#> crs        : +proj=longlat +datum=WGS84 +no_defs 
#> names      :     T2005,     T2006,     T2007,     T2008,     T2009,     T2010,     T2011,     T2012,     T2013,     T2014,     T2015,     T2016,     T2017,     T2018,     T2019 
#> min values : -1.729472, -1.922672, -1.420243, -2.064614, -1.873687, -1.659296, -2.218065, -2.015260, -1.726515, -2.484518, -3.418857, -1.920852, -1.957272, -2.600349, -1.871242 
#> max values :  1.548122,  1.758537,  1.973046,  1.730125,  2.713391,  2.031871,  1.629500,  1.930965,  1.895613,  1.537536,  1.115057,  1.845269,  1.354448,  1.440349,  1.297540 
#> 
#> 
#> $temp
#> class      : RasterStack 
#> dimensions : 5, 5, 25, 15  (nrow, ncol, ncell, nlayers)
#> resolution : 1.197331, 0.8703872  (x, y)
#> extent     : -95.23445, -89.24779, 36.11935, 40.47128  (xmin, xmax, ymin, ymax)
#> crs        : +proj=longlat +datum=WGS84 +no_defs 
#> names      :     T2005,     T2006,     T2007,     T2008,     T2009,     T2010,     T2011,     T2012,     T2013,     T2014,     T2015,     T2016,     T2017,     T2018,     T2019 
#> min values : -2.254533, -1.601675, -1.757465, -2.662935, -1.714059, -1.687656, -1.912300, -2.004042, -2.211060, -2.113791, -2.222009, -2.118209, -1.648113, -2.085452, -3.701192 
#> max values :  1.617314,  1.843411,  2.197493,  1.832317,  2.438909,  1.775691,  2.742359,  2.219493,  1.490701,  2.165628,  1.542824,  2.040302,  1.842104,  1.938088,  1.898895
```

For raster predictions, covariates are supplied to 'strv_predict' by giving the covariate raster list for the covariates is supplied as the third argument.
The output uses the same format as raster predictions without covariates, but the resulting stars raster for each year has  additional layer containing the covariate values.


```r
strv_predict(
  bird_model,
  pred_raster,
  pred_covar,
  time = min(bird_survey$year):2019
)
#> stars object with 4 dimensions and 6 attributes
#> attribute(s):
#>                    Min.   1st Qu.    Median      Mean   3rd Qu.       Max.
#> w            -0.2025668 1.2015224 1.7329527 1.6750742 2.2555686  3.2635658
#> w_se          0.1200513 0.2416083 0.3112663 0.3629338 0.4477158  0.8557821
#> linear       -0.1919335 1.2165337 1.7458450 1.6761962 2.2703797  3.2754011
#> linear_se     0.1252560 0.2422768 0.3129134 0.3643183 0.4484526  0.8567377
#> response      0.8253618 3.3755541 5.7307420 6.9398890 9.6832895 26.4538364
#> response_se   0.3154363 1.1198097 1.8130032 2.3646663 2.9894075 11.2794065
#> dimension(s):
#>          from to   offset     delta refsys point        values x/y
#> x           1  5 -95.2344   1.19733 WGS 84 FALSE          NULL [x]
#> y           1  5  40.4713 -0.870387 WGS 84 FALSE          NULL [y]
#> year        1 15     2005         1     NA    NA 2005,...,2019    
#> variable    1  1       NA        NA     NA    NA           cnt
```




```r
bird_model<- original_model
```




# Options

## Using an INLA mesh for the persistent graph

The underlying structure of the random effects is described by a directed acyclic graph, which is analogous to the mesh used in the INLA package.
If desired an INLA mesh can be supplied to the 'strv_prepare' function, which will translate the mesh into a directed acyclic graph.
Using an INLA mesh is roughly equivalent to using a spatially dense set of nodes with a small value for n_neighbours, so can often improve computation speed compared to the default behaviour of 'strv_prepare'.
An additional benefit is that an INLA mesh can be constructed to run around barriers so that no nodes are inside the barrier and no edges go through the barrier.
Accounting for barriers can be important in examples such as marine ecology, where one needs to account for the fact that fish cannot (usually) swim over land.

See the INLA documentation ('?INLA::inla.mesh.2d') for details on how to create a mesh.
The performance of the INLA package is often sensitive to the exact construction of the mesh, however the starve package is not very sensitive when translating an INLA mesh to a graph.

Once a mesh has been created, you can simply supply the mesh object to the 'nodes' argument of 'strv_prepare'.
In this case, the 'n_neighbours' argument determines the number of parents only for the transient graph / transient random effects and the number of parents when predicting new random effects using the 'strv_predict' function.


```r
mesh<- INLA::inla.mesh.2d(
  loc = sf::st_coordinates(bird_survey),
  max.edge = 1,
  cutoff = 0.2,
  crs = as(sf::st_crs(bird_survey), "CRS")
)
model<- strv_prepare(
  cnt ~ time(year, "rw"),
  bird_survey,
  mesh,
  distribution = "poisson",
  n_neighbours = 3,
  fit = TRUE
)
```

## Formula syntax

A model formula specifies the response variable, the covariate effects, the temporal structure, and the spatial structure.
Put together a model formula should have this general format:


```r
response ~ covariates + sample.size(...) + time(...) + space(...)
```

Some options to the individual terms in the above model formula can be specified, as described below.

- **covariates**: Covariate effects can be specified as they would be in a typical call to 'lm' or 'glm'. Can be omitted from the formula if no covariates effects are desired.
- **sample.size(...)**: Used only for specific response distributions, for example the binomial distribution. A single variable name should be supplied. Can be omitted from the formula, and sample sizes are assumed to be equal to 1 for all observations.
- **time(...,type=)**: The name of the column holding the time information should be given. For a purely spatial model, create a dummy 'time' column with entries all equal to the same value. Valid options for the type option are:
    - **independent**: Each year in the model is assumed to be independent. The 'ar1' time parameter is fixed at 0.
    - **ar1** (default): An autoregressive order 1 model is used. The 'ar1' time parameter is freely estimated.
    - **rw**: A random walk is used. The 'ar1' time parameter is fixed at 1.
- **space(...,covariance=,nu=)**: The name of the covariance function should be given to the covariance argument. If using the 'matern' covariance function, supplying a value to the nu option fixes the smoothness parameter nu at that value. Can be omitted from the formula, in which case the default exponential covariance function will be used.


## Response distribution

The valid response distributions can be found with the 'get_starve_distributions' function:


```r
get_starve_distributions("distribution")
#>         distribution         distribution         distribution         distribution         distribution         distribution         distribution         distribution         distribution         distribution         distribution 
#>           "gaussian"            "poisson"  "negative binomial"          "bernoulli"              "gamma"          "lognormal"           "binomial" "atLeastOneBinomial"            "compois"            "tweedie"                  "t"
```

- **gaussian**: Used for continuous data. Random effects and covariates determine the mean.
    - Parameters
        - **sd**: standard deviation of response variable.
    - Default link: identity

- **t**: Used for continuous data, similar to gaussian distribution with heavier tails. Random effects and covariates determine the mean.
    - Parameters
        - **df**: degrees of freedom.
    - Default link: identity

- **gamma**: Models strictly positive continuous data. Random effects and covariates determine the mean.
    - Parameters
        - **sd**: standard deviation of response variable.
    - Default link: log

- **lognormal**: Models strictly positive continuous data. Random effects and covariates determine the mean.
    - Parameters
        - **sd**: standard deviation of the log of response variable.
    - Default link: log

- **tweedie**: Models non-negative continuous data with a point mass at zero. Random effects and covariates determine the mean. The relationship between the mean and variance is given by $Var(Y) = \sigma^{2}\mu^{p}$.
    - Parameters
        - **dispersion**: The parameter $\sigma^{2}$ above.
        - **power**: The parameter $p$ above.
    - Default link: log

- **poisson**: Models non-negative integer data. Random effects and covariates determine the intensity/mean.
    - Parameters
        - N/A
    - Default link: log

- **negative binomial**: Model non-negative integer data with possible overdispersion. Random effects and covariates determine the mean.
    - Parameters
        - **overdispersion**: Values >1 correspond to overdispersion.
    - Default link: log

- **compois**: Models non-negative integer data with possible over- or underdispersion. Random effects and covariates determine the mean.
    - Parameters
        - **dispersion**: Values <1 correspond to underdispersion. Values >1 correspond to overdispersion
    - Default link: log

- **bernoulli**: Models binary data. Random effects and covariates determine the probability of success.
    - Parameters
        - N/A
    - Default link: logit

- **binomial**: Models the number of successes in *k* iid Bernoulli trials. Random effects and covariates determine the probability of success in a single trial. The number of trials *k* is specificed through the 'sample.size' term in the model formula.
    - Parameters
        - N/A
    - Default link: logit

- **atLeastOneBinomial**: Models the probability of observing at least one success in *k* iid Bernoulli trials. Random effects and covariates determine the probability of success in a single trial. The number of trials *k* is specified through the 'sample.size' term in the model formula.
    - Parameters
        - N/A
    - Default link: logit

## Link functions

The valid link functions can be found with the 'get_starve_distributions' function:


```r
get_starve_distributions("link")
#>       link       link       link 
#> "identity"      "log"    "logit"
```

- **identity**
    - Range (-$\infty$,$\infty$)

- **log**:
    - Range [0,$\infty$)

- **logit**:
    - Range [0,1]

## Spatial covariance function

All covariance functions currently available are special cases of the Matern covariance function.


```r
get_starve_distributions("covariance")
#>    covariance    covariance    covariance    covariance 
#> "exponential"    "gaussian"      "matern"    "matern32"
```

- **exponential**
    - Smoothness parameter nu = 0.5
- **matern32**
    - Smoothness parmaeter nu = 1.5
- **gaussian**
    - Limit of Matern covariance function as nu$\to\infty$
- **matern**
    - General covariance function with a freely estimated smoothness parameter nu. Evaluation is very slow compared to the named special cases.

## Holding parameters fixed

You can hold parameters fixed during model fitting.
Instead of being estimated the parameter value held in the starve model will be assumed "true".
We will hold the ar1 parameter fixed at 0, setting up each year in the model to be independent of the other years.
You can set as many parameters as you want to be held fixed, however the random effects cannot be fixed to particular values.
A model with all parameters held constant can still be fitted with the 'strv_fit' function, in which case the time effects and random effects will be estimated along with their standard errors.


```r
parameters(bird_model)
#> An object of class "parameters"
#> Slot "covariance_function":
#> [1] "exponential"
#> 
#> Slot "space_parameters":
#> $cnt
#>               par          se fixed
#> sd     0.02174469 0.002401241 FALSE
#> range 80.00000000 0.000000000  TRUE
#> nu     0.50000000 0.000000000  TRUE
#> 
#> 
#> Slot "time_parameters":
#> $cnt
#>           par         se fixed
#> mu  1.8539486 1.39041602 FALSE
#> ar1 0.9900000 0.00000000  TRUE
#> sd  0.1929791 0.05787956 FALSE
#> 
#> 
#> Slot "response_distribution":
#> [1] "poisson"
#> 
#> Slot "response_parameters":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
#> 
#> 
#> Slot "link_function":
#> [1] "log"
#> 
#> Slot "fixed_effects":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)

time_parameters(bird_model)$cnt["ar1", "par"]<- 0
time_parameters(bird_model)$cnt["ar1", "fixed"]<- TRUE
bird_model<- strv_fit(bird_model, silent = TRUE)

parameters(bird_model)
#> An object of class "parameters"
#> Slot "covariance_function":
#> [1] "exponential"
#> 
#> Slot "space_parameters":
#> $cnt
#>              par          se fixed
#> sd     0.1040975 0.005029526 FALSE
#> range 80.0000000 0.000000000  TRUE
#> nu     0.5000000 0.000000000  TRUE
#> 
#> 
#> Slot "time_parameters":
#> $cnt
#>              par         se fixed
#> mu  2.035864e+00 0.08870732 FALSE
#> ar1 0.000000e+00 0.00000000  TRUE
#> sd  6.150842e-05 0.07372249 FALSE
#> 
#> 
#> Slot "response_distribution":
#> [1] "poisson"
#> 
#> Slot "response_parameters":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
#> 
#> 
#> Slot "link_function":
#> [1] "log"
#> 
#> Slot "fixed_effects":
#> $cnt
#> [1] par   se    fixed
#> <0 rows> (or 0-length row.names)
```
