---
title: "staRVe-tour"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{staRVe-tour}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(staRVe)
```



# Data

```{r data}
data(bird_survey)
bird_survey
```

```{r}
bird_survey<- subset(bird_survey,year >= 2005)
```



# The staRVe model object

## Creating and fitting a model

```{r create-model}
bird_model<- prepare_staRVe_model(
  cnt ~ time(year),
  data = bird_survey,
  distribution = "poisson"
)
```

Starting values for the optimizer are the values of the parameters held in the staRVe model object at the time that staRVe_fit is called. Details for changing these values is later in section ###.
```{r fit-model}
bird_model<- staRVe_fit(
  bird_model,
  silent=T
)
```

```{r cache-model,include=F}
cache_model<- bird_model
```



## Parameter estimates

```{r convergence}
convergence(bird_model)
```

```{r parameters}
parameters(bird_model)
```

```{r spatial-parameters}
spatial_parameters(bird_model)
```

```{r time-parameters}
time_parameters(bird_model)
```

```{r response-distribution}
response_parameters(bird_model)
```

```{r fixed-effects}
fixed_effects(bird_model)
```

## Random effect predictions

```{r time-effects}
time_effects(bird_model)
```

```{r random-effects}
random_effects(bird_model)
```

## Data

```{r dat}
dat(bird_model)
```

## Settings

```{r settings}
settings(bird_model)
```

## Modifying a staRVe model

```{r change-pars}
parameters(bird_model)

time_parameters(bird_model)[c("mu","ar1"),"par"]<- c(10,0.75)
spatial_parameters(bird_model)["sd","par"]<- 0.5

parameters(bird_model)
```

```{r change-distribution}
parameters(bird_model)
response_distribution(bird_model)<- "gaussian"
parameters(bird_model)
```

```{r change-link}
parameters(bird_model)
link_function(bird_model)<- "logit"
parameters(bird_model)
```

```{r change-covariance}
parameters(bird_model)
covariance_function(bird_model)<- "matern32"
parameters(bird_model)
```

```{r change-units}
graph(bird_model)
distance_units(bird_model)<- "ft"
graph(bird_model)
```

```{r include = F}
bird_model<- cache_model
```



## (Advanced)

(INLA mesh, TMB object, graph, pre-computed graphs, optimizer settings)





# Predictions

## Point predictions

```{r predict-points}
pred_points<- st_sample(
  st_as_sfc(st_bbox(bird_survey)),
  size = 5
)
pred_points<- st_sf(geom = pred_points)
```

```{r predict-sf}
staRVe_predict(
  bird_model,
  pred_points
)
```

```{r forecast-sf}
staRVe_predict(
  bird_model,
  pred_points,
  time = 2015:2019
)
```

## Raster predictions

(Add in how to mask rasters for prediction)

```{r}
library(raster)
pred_raster<- raster(
  bird_survey,
  nrow = 5,
  ncol = 5
)
```

Raster predictions extract the centroid of each cell and then gives predictions at those point locations.
Raster predictions are not predictions of the average value within the cell.
```{r predict-raster}
staRVe_predict(
  bird_model,
  pred_raster
)
```

```{r forecast-raster}
staRVe_predict(
  bird_model,
  pred_raster,
  time = 2015:2019
)
```





# Simulation

Mention residual analysis here

## Simulating random effects and observations

```{r simulate-all}
sim_model<- staRVe_simulate(
  bird_model
)
```

## Simulating only observations

```{r simulate-obs}
sim_model<- staRVe_simulate(
  bird_model,
  conditional = T
)
```





# Including covariates

## Creating a model

```{r data-covar}
bird_survey$elev<- rnorm(
  nrow(bird_survey)
)
bird_survey$temp<- rnorm(
  nrow(bird_survey)
)
```

```{r covar-fit-elev}
bird_model<- prepare_staRVe_model(
  cnt ~ time(year) + mean(poly(elev,2)),
  bird_survey,
  distribution = "poisson",
  fit = T
)
```

```{r}
fixed_effects(bird_model)
dat(bird_model)
```

```{r covar-fit-elev-temp}
bird_model<- prepare_staRVe_model(
  cnt ~ time(year) + mean(elev*temp+I(elev^2)),
  bird_survey,
  distribution = "poisson",
  fit = T
)
```

```{r}
fixed_effects(bird_model)
dat(bird_model)
```

## Point predictions

You do not need to remove extra years of covariates.
The predict function will automatically remove the extra covariate observations.

```{r covar-points}
pred_covar<- do.call(rbind,lapply(min(bird_survey$year):2019,function(year) {
  return(st_sf(data.frame(year=year,pred_points)))
}))
pred_covar$elev<- rnorm(nrow(pred_covar))
pred_covar$temp<- rnorm(nrow(pred_covar))
pred_covar
```

```{r pred-covar-sf}
staRVe_predict(
  bird_model,
  pred_points,
  pred_covar
)
```

```{r forecast-covar-sf}
staRVe_predict(
  bird_model,
  pred_points,
  pred_covar,
  time = 2015:2019
)
```


## Raster predictions

```{r covar-raster}
raster_elev<- stack(lapply(min(bird_survey$year):2019,function(year) {
  band<- pred_raster
  band[]<- rnorm(ncell(band))
  names(band)<- paste0("T",year)
  return(band)
}))
raster_temp<- stack(lapply(min(bird_survey$year):2019,function(year) {
  band<- pred_raster
  band[]<- rnorm(ncell(band))
  names(band)<- paste0("T",year)
  return(band)
}))
pred_covar<- list(
  elev = raster_elev,
  temp = raster_temp
)
pred_covar
```

```{r pred-covar-raster}
staRVe_predict(
  bird_model,
  pred_raster,
  pred_covar
)
```

```{r forecast-covar-raster}
staRVe_predict(
  bird_model,
  pred_raster,
  pred_covar,
  time = 2015:2019
)
```




# Options

## Response distribution

(Make sure to describe each distribution)

```{r staRVe-distributions}
get_staRVe_distributions("distribution")
```

## Link functions

```{r staRVe-links}
get_staRVe_distributions("link")
```

## Spatial covariance function

```{r staRVe-covariances}
get_staRVe_distributions("covariance")
```

## Holding parameters fixed

```{r fixed-parameters}
time_parameters(bird_model)["ar1","par"]<- 0
time_parameters(bird_model)["ar1","fixed"]<- T
```



# Common problems

# Need more neighbours / fewer nodes

If the estimated time_effects are approximately constant (the same value each year), you should consider setting n_neighbours to a higher value or using a less dense set of nodes.

```{r flat-time-effects, eval=F}
data(bird_survey)
bird_survey<- subset(bird_survey,year >= 2005)
bird_model<- prepare_staRVe_model(
  cnt ~ time(year),
  data = bird_survey,
  distribution = "poisson",
  fit = T
)
time_effects(bird_model)
```
